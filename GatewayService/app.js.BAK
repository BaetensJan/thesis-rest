require("dotenv").config();
const gateway = require("fast-gateway");
const express = require("express");
const expressJwt = require("express-jwt");
const cors = require("cors");
const helmet = require("helmet");

const port = 8080;
const app = express();

//TODO: seperate file?
const server = gateway({
  server: app,
  middlewares: [
    cors(),
    helmet(),
    expressJwt({
      secret: process.env.JWT_SECRET,
      algorithms: ["HS256"],
      credentialsRequired: false,
    }),
  ],
  routes: [
    {
      prefix: "/accounts",
      target: "http://127.0.0.1:3000",
      proxyHandler: (req, res, url, proxy, proxyOpts) => {
        req.header("user", req.user);
        proxy(req, res, url, proxyOpts);
      },
    },
  ],
});

server.listen(port, () =>
  console.log(`Gateway listening at http://localhost:${port}`)
);
